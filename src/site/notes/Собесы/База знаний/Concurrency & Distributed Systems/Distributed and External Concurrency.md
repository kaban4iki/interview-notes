---
{"dg-publish":true,"permalink":"/sobesy/baza-znanij/concurrency-and-distributed-systems/distributed-and-external-concurrency/"}
---

## Конкурентность за пределами одного процесса

**Кратко:**  
Distributed concurrency возникает, когда несколько процессов или сервисов работают параллельно и взаимодействуют через сеть.  
Ключевые отличия от локальной конкурентности:
- нет общей памяти
- высокая latency
- возможны частичные отказы
- отсутствует единое состояние времени

**Типовой вопрос:**  
Почему распределённая конкурентность сложнее локальной?

**Ответ:**  
Потому что:
- нельзя полагаться на атомарность операций
- сеть ненадёжна по определению
- синхронизация требует внешних механизмов
- ошибки проявляются не детерминированно

---

## Distributed Locks

**Кратко:**  
Distributed lock — механизм взаимного исключения между процессами.  
Используется для:
- защиты критических секций
- предотвращения дубликатов
- координации фоновых задач

**Типовой вопрос:**  
Почему distributed lock — источник багов?

**Ответ:**  
Потому что:
- возможна потеря lock при сетевом разрыве
- сложно корректно обрабатывать timeout
- clock skew влияет на логику

Lock не гарантирует безопасность, если не учтены сбои.

---

## Redis Locks

**Кратко:**  
Redis часто используют для распределённых блокировок.  
Типичная реализация:
- `SET key value NX PX ttl`
- проверка владения перед удалением

**Типовой вопрос:**  
Почему простой Redis lock может быть небезопасен?

**Ответ:**  
Потому что:
- процесс может умереть до release
- TTL может истечь раньше завершения работы
- возможна потеря эксклюзивности

Без строгого протокола возможны race condition.

---

## Leader Election

**Кратко:**  
Leader election выбирает один активный процесс из группы.  
Используется для:
- cron-задач
- миграций
- координации кластеров

**Типовой вопрос:**  
Что происходит при падении лидера?

**Ответ:**  
Система:
- обнаруживает потерю heartbeat
- запускает повторный выбор
- назначает нового лидера

Важно учитывать задержки и split-brain.

---

## Split Brain

**Кратко:**  
Split brain — ситуация, когда несколько узлов считают себя лидерами.  
Возникает при сетевых разделениях.

**Типовой вопрос:**  
Почему split brain опасен?

**Ответ:**  
Потому что:
- данные расходятся
- операции выполняются дважды
- восстановление требует ручного вмешательства

Предотвращается quorum-механизмами.

---

## HTTP Clients и Connection Pooling

**Кратко:**  
HTTP-клиенты управляют соединениями к внешним сервисам.  
Connection pool:
- переиспользует соединения
- снижает latency
- ограничивает конкуренцию

**Типовой вопрос:**  
Почему connection pool важен?

**Ответ:**  
Без него:
- создаётся слишком много TCP-соединений
- растёт нагрузка на ОС
- увеличивается время ответа

Размер пула — архитектурное решение.

---

## Rate Limiting между сервисами

**Кратко:**  
Ограничение запросов нужно не только для клиентов, но и между сервисами.

**Типовой вопрос:**  
Почему internal rate limit необходим?

**Ответ:**  
Потому что:
- один сервис может перегрузить другой
- баги приводят к лавине запросов
- защита должна быть симметричной

---

## Защита от деградации внешних сервисов

**Кратко:**  
Внешние сервисы всегда могут деградировать.

**Типовой вопрос:**  
Минимальный набор защит?

**Ответ:**  
- таймауты
- retry с backoff
- circuit breaker
- fallback или деградация функциональности

Без этого отказ распространяется по системе.